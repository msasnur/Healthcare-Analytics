name: Giskard Scan

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'hyper-parameters.yaml'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'
          cache: 'pip' # caching pip dependencies
      - uses: syphar/restore-virtualenv@v1
        id: cache-virtualenv
        with:
          requirement_files: requirements.txt  # this is optional

      - uses: syphar/restore-pip-download-cache@v1
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'

        # the package installation will only be executed when the
        # requirements-files have changed.
      - run: pip install -r requirements.txt
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'
      - uses: yaananth/run-notebook@v2
        env:
          RUNNER: ${{ toJson(runner) }}
          SECRETS: ${{ toJson(secrets) }}
          GITHUB: ${{ toJson(github) }}
        with:
          notebook: "healthcare_analytics_xgboost.ipynb"
          isReport: False
          poll: False
      - name: Run the Giskard Scan üê¢
        id: giskard_scan
        run: |
          python scan.py
          output=$(find report -iname "*.md" -exec basename {} .md ';')
          echo "::set-output name=report_name::$output"
      - name: Extract branch name üå≤
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Upload the scan report ü§ñ
        id: extract_sha
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          mkdir -p reports
          cp report/* reports/.
          git add reports
          git commit -m "ü§ñ github-bot: Updated Reports"
          git push
          echo "::set-output name=sha::$(git rev-parse HEAD)"
      - name: Extract md report
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "text<<$EOF" >> $GITHUB_OUTPUT
          echo "md_report=$(cat report/*.md)" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
        id: extract_md_report
      - name: PR comment ü§ñ
        uses: wow-actions/auto-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pullRequestOpened: |
            Hi, this is a report generated by the **Giskard scan** üê¢.
            
            We have identified potential **vulnerabilities** in your model based on an automated scan.
            
            However, it's important to note that automated scans may produce false positives or miss certain vulnerabilities. We encourage you to review the findings and assess the impact accordingly.
            
            ## Report summary
            
            ${{ steps.extract_md_report.outputs.md_report }}
            
            [**View full report**](https://htmlpreview.github.io/?${{ github.server_url }}/${{ github.repository 
            }}/blob/${{ steps.extract_sha.outputs.sha }}/reports/${{ steps.giskard_scan.outputs.report_name }}.html)